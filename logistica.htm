<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Acompanhamento Logístico de SICs</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f4; }
        .container { background-color: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); max-width: 1200px; margin: auto; }
        h1 { color: #333; text-align: center; margin-bottom: 30px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; font-size: 14px; }
        th { background-color: #f2f2f2; color: #333; }
        tr:nth-child(even) { background-color: #f9f9f9; }
        
        /* Badges */
        .status-badge { display: inline-block; padding: 5px 8px; border-radius: 4px; font-size: 0.8em; color: white; font-weight: bold; white-space: nowrap; }
        .status-badge.Pendente { background-color: #ffc107; color: #333; }
        .status-badge.Aprovado { background-color: #28a745; }
        .status-badge.Reprovado { background-color: #dc3545; }
        .status-badge.AguardandoAgendamento { background-color: #6c757d; }
        .status-badge.EntregaAgendada { background-color: #17a2b8; }
        .status-badge.EmTransito { background-color: #007bff; }
        .status-badge.EntregaRecebida { background-color: #28a745; }
        .status-badge.ProblemaNaEntrega { background-color: #dc3545; }
        .status-badge.Devolucao { background-color: #6f42c1; }
        
        /* Actions */
        .actions-logistica select { padding: 5px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; margin-right: 5px; min-width: 150px; vertical-align: middle; }
        .actions-logistica input[type="date"] { padding: 5px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; margin-right: 5px; min-width: 150px; display: none; vertical-align: middle; }
        .actions-logistica button { padding: 6px 10px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; vertical-align: middle; }
        .actions-logistica button:hover { background-color: #0056b3; }
        .actions-logistica select:disabled, .actions-logistica button:disabled { background-color: #e9e9e9; cursor: not-allowed; }

        .no-sics { text-align: center; color: #666; padding: 20px; border: 1px dashed #ccc; border-radius: 5px; margin-top: 20px; }
        #message { margin-top: 20px; padding: 10px; border-radius: 4px; text-align: center; display: none; }
        .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        
        /* Unit Selection */
        .unit-selection-container { background-color: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); max-width: 400px; margin: auto; text-align: center; display: flex; flex-direction: column; justify-content: center; align-items: center; min-height: calc(100vh - 40px); }
        .unit-selection-container select { width: 100%; margin-bottom: 20px; }
        .unit-selection-container button { background-color: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; width: 100%; }
        #unitSelectionError { color: red; margin-top: 10px; display: none; }

        /* Password Modal */
        .password-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .password-modal { background-color: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3); text-align: center; width: 300px; }
        .password-modal input[type="password"] { width: calc(100% - 22px); padding: 10px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 4px; font-size: 16px; }
        .password-modal button { background-color: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; width: 100%; }
        #passwordError { color: red; margin-top: 10px; display: none; }
    </style>
</head>
<body>
    <div class="unit-selection-container" id="unitSelectionContainer">
        <h2>Selecione a Unidade - Logística</h2>
        <select id="selectUnitForAccess">
            <option value="">Selecione a Unidade</option>
            <option value="TPH">TPH</option>
            <option value="API">API</option>
            <option value="MCD">MCD</option>
            <option value="TCG">TCG</option>
            <option value="ABC">ABC</option>
            <option value="TCV">TCV</option>
            <option value="TBL">TBL</option>
            <option value="TSJ">TSJ</option>
            <option value="TBE">TBE</option>
            <option value="TPA">TPA</option>
            <option value="TCA">TCA</option>
        </select>
        <button id="proceedToPassword">Prosseguir</button>
        <p id="unitSelectionError"></p>
    </div>

    <div class="password-overlay" id="passwordOverlay" style="display: none;">
        <div class="password-modal">
            <h2>Senha de Acesso - Unidade <span id="selectedUnitName"></span></h2>
            <p>Por favor, insira a senha para a unidade selecionada.</p>
            <input type="password" id="accessPassword" placeholder="Senha da Unidade">
            <button id="submitPassword">Acessar</button>
            <p id="passwordError"></p>
        </div>
    </div>

    <div class="container" id="appContainer" style="display: none;">
        <h1>Acompanhamento Logístico - Unidade <span id="currentUnitDisplay"></span></h1>
        <div id="sicListLogistica"></div>
        <div id="message"></div>
    </div>

    <script>
        // --- SENHAS DE ACESSO ---
        const UNIT_PASSWORDS = {
            "TPH": "tphlog123", "API": "apilog123", "MCD": "mcdlog123", "TCG": "tcglog123", 
            "ABC": "abclog123", "TCV": "tcvlog123", "TBL": "tbllog123", "TSJ": "tsjlog123",
            "TBE": "tbalog123", "TPA": "tpalog123", "TCA": "tcalog123"
        };

        const OPERATIONAL_GROUPS = {
            "TPA": ["TPA", "TBE"], "TBE": ["TPA", "TBE"], "MCD": ["MCD", "TCG"],
            "TCG": ["MCD", "TCG"], "TCV": ["TCV", "ABC"], "ABC": ["TCV", "ABC"],
            "TPH": ["TPH"], "API": ["API"], "TBL": ["TBL"], "TSJ": ["TSJ"], "TCA": ["TCA"]
        };

        // --- DATAS LIMITE POR UNIDADE ---
        // A data abaixo é o ÚLTIMO dia que pode agendar (Inclusive).
        const UNIT_LIMIT_DATES = {
            "TCA": "2025-12-15",
            "MCD": "2025-12-15",
            "TCG": "2025-12-15",
            "TBE": "2025-12-16",
            "TPA": "2025-12-16",
            "ABC": "2025-12-16",
            "TCV": "2025-12-16",
            "TBL": "2025-12-16",
            "TBE/tba": "2025-12-16", // Mapeado caso venha assim do banco
            "API": "2025-12-18",
            "TPH": "2025-12-18",
            "TSJ": "2025-12-19"
        };
        
        const REOPEN_DATE = "2026-01-05"; // Data que volta a permitir (Inclusive)

        // Elementos DOM
        const unitSelectionContainer = document.getElementById('unitSelectionContainer');
        const selectUnitForAccess = document.getElementById('selectUnitForAccess');
        const proceedToPasswordBtn = document.getElementById('proceedToPassword');
        const unitSelectionError = document.getElementById('unitSelectionError');
        const passwordOverlay = document.getElementById('passwordOverlay');
        const selectedUnitNameSpan = document.getElementById('selectedUnitName');
        const accessPasswordInput = document.getElementById('accessPassword');
        const submitPasswordBtn = document.getElementById('submitPassword');
        const passwordError = document.getElementById('passwordError');
        const appContainer = document.getElementById('appContainer');
        const currentUnitDisplay = document.getElementById('currentUnitDisplay');

        let selectedUnit = '';
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbyMSn_ug8ybd_U0psLApK1TjCjo4Tsfvz4EUKe6C3bF5fYuwDePoRTrAG6sjk2JKPdO/exec';

        // --- Lógica de Acesso ---
        proceedToPasswordBtn.addEventListener('click', function() {
            selectedUnit = selectUnitForAccess.value;
            if (selectedUnit === '') {
                unitSelectionError.textContent = 'Por favor, selecione uma unidade.';
                unitSelectionError.style.display = 'block';
                return;
            }
            unitSelectionError.style.display = 'none';
            sessionStorage.setItem('logisticaSelectedUnit', selectedUnit);
            selectedUnitNameSpan.textContent = selectedUnit;
            unitSelectionContainer.style.display = 'none';
            passwordOverlay.style.display = 'flex';
            accessPasswordInput.focus();
        });

        submitPasswordBtn.addEventListener('click', function() {
            if (accessPasswordInput.value === UNIT_PASSWORDS[selectedUnit]) {
                passwordOverlay.style.display = 'none';
                appContainer.style.display = 'block';
                sessionStorage.setItem('logisticaAccessGranted', 'true');
                currentUnitDisplay.textContent = selectedUnit;
                renderSicsForLogistica(selectedUnit); 
            } else {
                passwordError.textContent = 'Senha incorreta.';
                passwordError.style.display = 'block';
            }
        });

        document.addEventListener('DOMContentLoaded', function() {
            selectedUnit = sessionStorage.getItem('logisticaSelectedUnit');
            const accessGranted = sessionStorage.getItem('logisticaAccessGranted') === 'true';
            if (selectedUnit && accessGranted) {
                unitSelectionContainer.style.display = 'none';
                appContainer.style.display = 'block';
                currentUnitDisplay.textContent = selectedUnit;
                renderSicsForLogistica(selectedUnit);
            } else if (selectedUnit) {
                unitSelectionContainer.style.display = 'none';
                passwordOverlay.style.display = 'flex';
                selectedUnitNameSpan.textContent = selectedUnit;
            }
        });

        function displayMessage(text, type) {
            const messageDiv = document.getElementById('message');
            messageDiv.textContent = text;
            messageDiv.className = type;
            messageDiv.style.display = 'block';
            setTimeout(() => { messageDiv.style.display = 'none'; }, 6000);
        }

        async function fetchSics(filterUnits = null) {
            try {
                let url = new URL(WEB_APP_URL);
                if (filterUnits) url.searchParams.append('filterUnits', filterUnits);
                const response = await fetch(url);
                const data = await response.json();
                return data.status === 'success' ? data.sics : [];
            } catch (error) {
                displayMessage('Erro de rede.', 'error');
                return [];
            }
        }

        // --- FUNÇÃO CRÍTICA: Validação de Data ---
        function checkDateRestriction(unitCode, dateStr) {
            // Se a unidade não estiver na lista, permite tudo (ou bloqueie se preferir)
            if (!UNIT_LIMIT_DATES[unitCode]) return { allowed: true };

            const limitDate = UNIT_LIMIT_DATES[unitCode];
            
            // Lógica de Comparação (String é mais segura para datas ISO YYYY-MM-DD)
            // É BLOQUEADO SE: (DataEscolhida > DataLimite) E (DataEscolhida < DataReabertura)
            // Exemplo TPH (Limite 18/12):
            // 18/12 > 18/12 -> Falso (Permitido)
            // 19/12 > 18/12 -> Verdadeiro E 19/12 < 05/01 -> Verdadeiro (Bloqueado)
            
            if (dateStr > limitDate && dateStr < REOPEN_DATE) {
                // Formatar data para exibição bonita no erro
                const parts = limitDate.split('-');
                const formattedLimit = `${parts[2]}/${parts[1]}/${parts[0]}`;
                return { 
                    allowed: false, 
                    message: `A unidade ${unitCode} recebe entregas apenas até o dia ${formattedLimit}. O agendamento retorna dia 05/01/2026.`
                };
            }
            return { allowed: true };
        }

        async function renderSicsForLogistica(unitMakingTheAccess) {
            const sicListDiv = document.getElementById('sicListLogistica');
            sicListDiv.innerHTML = '<p class="no-sics">Carregando SICs...</p>';
            
            const unitsInGroup = OPERATIONAL_GROUPS[unitMakingTheAccess] || [unitMakingTheAccess];
            const allSics = await fetchSics(JSON.stringify(unitsInGroup));
            const sicsToDisplay = allSics.filter(sic => unitsInGroup.includes(sic.unidade));

            if (sicsToDisplay.length === 0) {
                sicListDiv.innerHTML = `<p class="no-sics">Não há SICs pendentes.</p>`;
                return;
            }

            let tableHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>Número SIC</th>
                            <th>Unidade</th>
                            <th>Fornecedor</th>
                            <th>Status Fin.</th>
                            <th>Status Log.</th>
                            <th>Data Entrega</th> <th>Ação</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            sicsToDisplay.forEach(sic => {
                const statusLogClass = (sic.statusLogistico || '').replace(/\s/g, '');
                const statusFinClass = (sic.statusFinanceiro || '').replace(/\s/g, '');
                const scheduledDate = sic.dataEntregaAgendada ? new Date(sic.dataEntregaAgendada).toISOString().split('T')[0] : '';
                const isDisabled = (sic.statusFinanceiro !== 'Aprovado');

                tableHTML += `
                    <tr>
                        <td>${sic.numeroDaSic || ''}</td>
                        <td>${sic.unidade || ''}</td>
                        <td>${sic.fornecedor || ''}</td>
                        <td><span class="status-badge ${statusFinClass}">${sic.statusFinanceiro || ''}</span></td>
                        <td><span class="status-badge ${statusLogClass}">${sic.statusLogistico || ''}</span></td>
                        <td>
                            <input type="date" class="scheduled-delivery-date" 
                                   data-sic="${sic.numeroDaSic}" 
                                   data-unidade="${sic.unidade}" 
                                   value="${scheduledDate}" 
                                   ${sic.statusLogistico !== 'Entrega Agendada' ? 'style="display:none;"' : ''} 
                                   ${isDisabled ? 'disabled' : ''}>
                        </td>
                        <td class="actions-logistica">
                            <select class="new-status-logistico" data-financeiro-status="${sic.statusFinanceiro}" ${isDisabled ? 'disabled' : ''}>
                                <option value="Aguardando Agendamento" ${sic.statusLogistico === 'Aguardando Agendamento' ? 'selected' : ''}>Aguardando</option>
                                <option value="Entrega Agendada" ${sic.statusLogistico === 'Entrega Agendada' ? 'selected' : ''}>Agendada</option>
                                <option value="Em Trânsito" ${sic.statusLogistico === 'Em Trânsito' ? 'selected' : ''}>Em Trânsito</option>
                                <option value="Entrega Recebida" ${sic.statusLogistico === 'Entrega Recebida' ? 'selected' : ''}>Recebida</option>
                                <option value="Problema na Entrega" ${sic.statusLogistico === 'Problema na Entrega' ? 'selected' : ''}>Problema</option>
                                <option value="Devolucao" ${sic.statusLogistico === 'Devolucao' ? 'selected' : ''}>Devolução</option>
                            </select>
                            <button class="update-logistico-btn" data-sic="${sic.numeroDaSic}" ${isDisabled ? 'disabled' : ''}>Atualizar</button>
                        </td>
                    </tr>
                `;
            });
            tableHTML += `</tbody></table>`;
            sicListDiv.innerHTML = tableHTML;

            // Listeners
            document.querySelectorAll('.new-status-logistico').forEach(select => {
                select.addEventListener('change', function() {
                    const row = this.closest('tr');
                    const dateInput = row.querySelector('.scheduled-delivery-date');
                    const isApproved = this.dataset.financeiroStatus === 'Aprovado';
                    if (dateInput) {
                        if (this.value === 'Entrega Agendada' && isApproved) {
                            dateInput.style.display = 'inline-block';
                            dateInput.required = true;
                        } else {
                            dateInput.style.display = 'none';
                            dateInput.required = false;
                            dateInput.value = '';
                        }
                    }
                });
            });

            document.querySelectorAll('.update-logistico-btn').forEach(button => {
                button.addEventListener('click', async function() {
                    const numeroSic = this.dataset.sic;
                    const selectElement = this.previousElementSibling;
                    const newStatus = selectElement.value;
                    
                    if (selectElement.dataset.financeiroStatus !== 'Aprovado') {
                        displayMessage('Status Financeiro deve ser Aprovado.', 'error');
                        return;
                    }

                    const row = this.closest('tr');
                    const dateInput = row.querySelector('.scheduled-delivery-date');
                    let scheduledDate = null;

                    if (newStatus === 'Entrega Agendada') {
                        scheduledDate = dateInput.value;
                        if (!scheduledDate) {
                            displayMessage('Insira a data de entrega.', 'error');
                            return;
                        }

                        // --- VERIFICAÇÃO DA DATA (LÓGICA CORRIGIDA) ---
                        const sicUnit = dateInput.dataset.unidade; 
                        const validation = checkDateRestriction(sicUnit, scheduledDate);

                        if (!validation.allowed) {
                            displayMessage(`ERRO: ${validation.message}`, 'error');
                            return; // Bloqueia o envio
                        }
                    }
                    
                    await updateSicStatusLogistico(numeroSic, newStatus, scheduledDate);
                });
            });
        }

        async function updateSicStatusLogistico(numeroSic, newStatus, scheduledDate = null) {
            displayMessage('Atualizando...', 'info');
            const formData = new FormData();
            formData.append('action', 'updateStatus');
            formData.append('numeroSic', numeroSic);
            formData.append('newStatus', newStatus);
            formData.append('statusField', 'Status Logistico');
            formData.append('sendEmail', 'true');
            if (newStatus === 'Entrega Agendada' && scheduledDate) {
                formData.append('scheduledDeliveryDate', scheduledDate);
            } else {
                formData.append('scheduledDeliveryDate', ''); 
            }

            try {
                const response = await fetch(WEB_APP_URL, { method: 'POST', body: formData });
                const result = await response.json();
                if (result.status === 'success') {
                    displayMessage('Atualizado com sucesso!', 'success');
                    renderSicsForLogistica(selectedUnit);
                } else {
                    displayMessage('Erro: ' + result.message, 'error');
                }
            } catch (error) {
                displayMessage('Erro de conexão.', 'error');
            }
        }
    </script>
</body>
</html>
